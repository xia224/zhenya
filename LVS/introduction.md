# Introduction to LVS

[Knowleage base url](http://www.linuxvirtualserver.org/zh/lvs1.html)
## key points from the above doc

瓶颈：
    网络带宽
    服务器性能，包括处理器效率、IO调度、操作系统调度
    协议栈（TCP/IP）

P1: 如何建立可伸缩的网络服务来满足不断增长的负载需求已成为迫在眉睫的问题
P2: 网络服务的可靠性要求
P3: 应用本身的发展也需要越来越强的处理性能

### 服务器集群系统
1. 对称多处理（Symmetric Multi-Processor，简称SMP）是由多个对称的处理器、和通过总线共享的内存和I/O部件所组成的计算机系统。

2. 通过高性能网络或局域网互联的服务器集群正成为实现高可伸缩的、高可用网络服务的有效结构。     
    性能：网络服务的工作负载通常是大量相互独立的任务，通过一组服务器分而治之，可以获得很高的整体性能。
    可伸缩性
    高可用性

    挑战性工作：
        2.1. 透明性
        如何高效地使得由多个独立计算机组成的松藕合的集群系统构成一个虚拟服务器；客户端应用程序与集群系统交互时，就像与一台高性能、高可用的服务器交互一样，客户端无须作任何修改。部分服务器的切入和切出不会中断服务，这对用户也是透明的。
        2.2. 性能
        性能要接近线性加速，将负载较均衡地调度到各台服务器上。
        2.3. 高可用性
        系统资源和故障的监测和处理系统，故障迁移。
        2.4. 可编程性、可管理性

### Linux Virtual Server项目
针对高可伸缩、高可用网络服务的需求，我们给出了基于IP层和基于内容请求分发的负载平衡调度解决方法，并在Linux内核中实现了这些方法，将一组服务器构成一个实现可伸缩的、高可用网络服务的虚拟服务器。

在LVS框架中，提供了__含有三种IP负载均衡技术的IP虚拟服务器软件IPVS、基于内容请求分发的内核Layer-7交 换机KTCPVS和集群管理软件__。

### IP虚拟服务器软件IPVS：
    VS/NAT：通过网络地址转换，调度器重写请求报文的目的ip地址，根据预设的调度算法，将请求分派给后端的真实服务器；
    真实服务器的响应报文通过调度器时，报文的源地址被重写，再返回给用户，完成整个负载调度过程。
    缺点：请求和响应报文都必须经过调度器重写地址，当用户请求越来越多时，调度器的处理能力将成为瓶颈。

    VS/TUN：为了解决上面NAT技术的痛点，调度器把请求报文通过IP隧道转发至真实服务器，而真实服务器将响应直接返回给用户，所以调度器只处理请求报文。
    如果网络服务应答比请求报文大很多，采用此技术后，集群系统的最大吞吐量可以提高10倍。

    VS/DR：调度器通过改写请求报文的MAC地址，将请求发送到真实服务器，而真实服务器将响应直接返回给用户。
    此方法没有IP隧道的开销，也不要求真实服务器支持IP隧道协议。
    但是，要求调度器与真实服务器都有一块网卡连在同一物理网段上。

#### IPVS调度器实现了如下八种负载调度算法
1. 轮转（Round Robin）
调度器将外部请求顺序分配到集群中的真实服务器，均等对待每一台服务器，而不管服务器上实际的连接数和系统负载。

2. 加权轮转
调度器主动询问或被动被告知真实服务器的处理能力来调度访问请求，能者多劳。

3. 最少链接
调度器通过“最少连接”调度算法将网络请求调度到已建立的连接数最少的服务器上。如果真实服务器间的系统性能相近的话，效果最好。

4. 加权最少连接
此法适用于集群系统中的服务器性能差异较大的情况。

5. 基于局部性的最少连接
"基于局部性的最少链接" 调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用"最少链接"的原则选出一个可用的服务 器，将请求发送到该服务器。

6. 带复制的基于局部性最少链接
"带复制的基于局部性最少链接"调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。它与LBLC算法的不同之处是它要维护从一个 目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务 器组，按"最小连接"原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按"最小连接"原则从这个集群中选出一 台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的 程度。

7. 目标地址散列
调度算法根据请求的目标IP地址，作为散列键，从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。

8. 源地址散列
调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。

### 内核Layer-7交换机KTCPVS
IPVS无法检查到请求的内容再选择服务器，这就要求后端服务器组提供相同的服务。
但是，有些应用中后端服务器功能不一， 这就需要基于内容的调度。

由于用户空间TCP Gateway的开销太大，我们提出在操作系统的内核中实现Layer-7交换方法，来避免用户空间与核心空间的切换和内存复制的开销。

虽然应用层交换处理复杂，它的伸缩性有限，但应用层交换带来以下好处：

相同页面的请求被发送到同一服务器，可以提高单台服务器的Cache命中率。
一些研究表明WEB访问流中存在局部性。Layer-7交换可以充分利用访问的局部性，将相同类型的请求发送到同一台服务器，使得每台服务器收到的请求具有更好的相似性，可进一步提高单台服务器的Cache命中率。
后端服务器可运行不同类型的服务，如文档服务，图片服务，CGI服务和数据库服务等。

### 负载均衡 综合负载
1. 输入指标
调度器上收集到的
输入指标主要是在单位时间内服务器收到新连接数与平均连接数的比例

2. 服务器指标
服务器指标主要记录服务器各种负载信息，如服务器当前CPU负载LOADi、服务器当前磁盘使用情况Di、当前内存利用情况Mi和当前进程数目 Pi。有两种方法可以获得这些信息；一是在所有的服务器上运行着SNMP（Simple Network Management Protocol）服务进程，而在调度器上的Monitor Daemon通过SNMP向各个服务器查询获得这些信息；二是在服务器上实现和运行收集信息的Agent，由Agent定时地向Monitor Daemon报告负载信息。若服务器在设定的时间间隔内没有响应，Monitor Daemon认为服务器是不可达的，将服务器在调度器中的权值设置为零，不会有新的连接再被分配到该服务器；若在下一次服务器有响应，再对服务器的权值进 行调整。再对这些数据进行处理，使其落在[0, ∞)的区间内，1表示负载正好，大于1表示服务器超载，小于1表示服务器处于低负载状态。获得调整后的数据有DISKi、MEMORYi和 PROCESSi。

另一个重要的服务器指标是服务器所提供服务的响应时间，它能比较好地反映服务器上请求等待队列的长度和请求的处理时间。
我们引入一组可以动态调整的系数Ri来表示各个负载参数的重要程度，其中ΣRi = 1。